<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case - NetSuite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 12px;
            color: #333;
            background: #f5f5f5;
        }

        /* Header Styles */
        .top-bar {
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .oracle-netsuite-logo {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .oracle-text {
            font-size: 9px;
            color: #666;
            letter-spacing: 1px;
        }

        .netsuite-text {
            font-size: 18px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .picarro-logo {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            letter-spacing: 2px;
        }

        .sandbox-badge {
            background: #f0f0f0;
            color: #666;
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box input {
            width: 200px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 12px;
            color: #666;
        }

        .help-link, .feedback-link {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .user-info {
            text-align: right;
            font-size: 11px;
        }

        .user-name {
            font-weight: bold;
            color: #333;
        }

        .user-company {
            color: #666;
        }

        /* Navigation */
        .main-nav {
            background: #4a4a4a;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }

        .nav-icon {
            padding: 10px 12px;
            color: #fff;
            cursor: pointer;
        }

        .nav-icon:hover {
            background: #5a5a5a;
        }

        .nav-item {
            padding: 10px 15px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .nav-item:hover {
            background: #5a5a5a;
        }

        .nav-item.active {
            background: #2e7d32;
        }

        /* Page Header */
        .page-header {
            background: #fff;
            padding: 10px 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title h1 {
            font-size: 16px;
            font-weight: normal;
            color: #333;
        }

        .page-title-icon {
            width: 24px;
            height: 24px;
            background: #2e7d32;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
        }

        .btn-generate-report {
            background: #1565c0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn-generate-report:hover {
            background: #0d47a1;
        }

        .search-icon {
            cursor: pointer;
            color: #666;
        }

        .page-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-save {
            background: #2e7d32;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .btn-save:hover {
            background: #256329;
        }

        .btn-save-dropdown {
            background: #256329;
            color: #fff;
            border: none;
            border-left: 1px solid #1e5120;
            padding: 6px 8px;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ccc;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-cancel:hover {
            background: #e8e8e8;
        }

        /* Right Panel Actions */
        .right-panel-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #0066cc;
            font-size: 12px;
        }

        .right-panel-actions span {
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            display: flex;
            padding: 0;
        }

        .form-container {
            flex: 1;
            padding: 0;
            background: #fff;
        }

        .file-drop-area {
            position: fixed;
            top: 10px;
            right: 60px;
            width: 120px;
            background: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            color: #666;
            font-size: 10px;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-drop-area:hover {
            background: #e8f5e9;
            border-color: #2e7d32;
        }

        .file-drop-icon {
            font-size: 18px;
            margin-bottom: 4px;
            color: #2e7d32;
        }

        /* Section Styles */
        .form-section {
            border-bottom: 1px solid #eee;
        }

        .section-header {
            background: #e8f5e9;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover {
            background: #dcedc8;
        }

        .section-toggle {
            font-size: 10px;
            color: #666;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-title {
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }

        .section-content {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px 24px;
        }

        .section-content.collapsed {
            display: none;
        }

        /* Form Field Styles */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-self: start;
        }

        .form-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: normal;
        }

        .form-label.required::after {
            content: ' *';
            color: #d32f2f;
        }

        .form-input,
        .form-select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
            background: #fff;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 1px #2e7d32;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
        }

        .form-input.readonly {
            background: #f5f5f5;
            color: #666;
        }

        .form-textarea {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 1px #2e7d32;
        }

        .autocomplete-input {
            position: relative;
        }

        .autocomplete-input input {
            width: 100%;
            padding-right: 28px;
        }

        .autocomplete-input::after {
            content: '‚ñº';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 8px;
            color: #666;
            pointer-events: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            cursor: pointer;
        }

        /* Tabs */
        .form-tabs {
            display: flex;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background: #fafafa;
        }

        .form-tab {
            padding: 10px 16px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            background: #fafafa;
        }

        .form-tab:hover {
            background: #f0f0f0;
        }

        .form-tab.active {
            color: #2e7d32;
            border-bottom-color: #2e7d32;
            background: #fff;
        }

        .tab-menu-icon {
            margin-left: auto;
            padding: 10px;
            color: #666;
            cursor: pointer;
        }

        /* Tab Content */
        .tab-content {
            padding: 16px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Bottom Section */
        .bottom-section {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 24px;
        }

        /* Footer Actions */
        .footer-actions {
            padding: 12px 16px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        /* Right sidebar */
        .right-sidebar {
            position: fixed;
            right: 0;
            top: 100px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 5px;
        }

        .sidebar-btn {
            width: 32px;
            height: 32px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
        }

        .sidebar-btn:hover {
            background: #f5f5f5;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            display: none;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-new {
            background: #4caf50;
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .autocomplete-item:hover {
            background: #e8f5e9;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Wide fields */
        .form-group.wide {
            grid-column: span 1;
        }

        .form-group.full-width {
            grid-column: span 3;
        }

        /* Communication tab content */
        .communication-content {
            padding: 20px;
            color: #666;
            text-align: center;
        }

        /* Address Tab Styles */
        .address-section {
            margin: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }

        .address-section-header {
            background: #607d8b;
            color: white;
            padding: 8px 12px;
            font-weight: 500;
            font-size: 12px;
        }

        .address-content {
            padding: 15px 20px;
        }

        .address-row {
            margin-bottom: 15px;
        }

        .address-label {
            display: block;
            color: #1565c0;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .address-select {
            width: 350px;
            max-width: 100%;
        }

        .address-display {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 12px 15px;
            min-height: 100px;
            width: 450px;
            max-width: 100%;
            position: relative;
        }

        .address-text {
            font-size: 12px;
            line-height: 1.6;
            color: #333;
        }

        .address-text div {
            margin-bottom: 2px;
        }

        .address-map-link {
            position: absolute;
            bottom: 10px;
            right: 15px;
            color: #1565c0;
            text-decoration: none;
            font-size: 12px;
        }

        .address-map-link:hover {
            text-decoration: underline;
        }

        /* Span two columns for textarea */
        .form-group.span-2 {
            grid-column: span 1;
        }

        /* Tab Section Styles */
        .tab-section {
            border: 1px solid #ddd;
            margin-bottom: 12px;
            background: #fff;
        }

        .tab-section-header {
            background: #e8f0f8;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #ddd;
        }

        .tab-section-header:hover {
            background: #dce8f4;
        }

        .tab-section-header-solid {
            background: #6b7b8a;
            padding: 8px 12px;
            color: #fff;
        }

        .tab-section-title {
            font-weight: bold;
            font-size: 12px;
        }

        .tab-section-content {
            padding: 12px;
        }

        .tab-section-content.collapsed {
            display: none;
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .summary-left,
        .summary-right {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .summary-left .form-textarea {
            width: 100%;
            min-width: 500px;
        }

        /* Solutions Section */
        .solutions-section .tab-section-content {
            background: #f5f5f5;
        }

        .solutions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 12px;
        }

        .solutions-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }

        .btn-action {
            background: #f5f5f5;
            border: 1px solid #ccc;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-action:hover {
            background: #e8e8e8;
        }

        .btn-action.btn-primary {
            background: #2e7d32;
            color: #fff;
            border-color: #2e7d32;
        }

        .btn-action.btn-primary:hover {
            background: #256329;
        }

        /* Communication Tab Styles */
        .comm-subtabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f5f5f5;
            margin-bottom: 12px;
        }

        .comm-subtab {
            padding: 8px 16px;
            font-size: 12px;
            color: #333;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .comm-subtab:hover {
            background: #e8e8e8;
        }

        .comm-subtab.active {
            color: #0066cc;
            font-weight: bold;
            border-bottom-color: #0066cc;
            background: #fff;
        }

        .comm-view-section {
            margin-bottom: 12px;
        }

        .comm-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f0f0f0;
            border: 1px solid #ddd;
        }

        .comm-table-container {
            overflow-x: auto;
        }

        .comm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .comm-table th {
            background: #e8f0f8;
            border: 1px solid #ccc;
            padding: 8px 10px;
            text-align: left;
            font-weight: normal;
            color: #333;
            white-space: nowrap;
        }

        .comm-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
        }

        .comm-table .no-records {
            color: #c00;
            padding: 12px;
            text-align: left;
        }

        /* Reports Section Styles */
        .reports-subtabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 12px;
        }

        .reports-subtab {
            padding: 8px 16px;
            font-size: 12px;
            color: #333;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            background: #f5f5f5;
            margin-right: 2px;
        }

        .reports-subtab:hover {
            background: #e8e8e8;
        }

        .reports-subtab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
            color: #2e7d32;
        }

        .reports-tab-content {
            display: none;
            padding: 12px 0;
        }

        .reports-tab-content.active {
            display: block;
        }

        .file-upload-area {
            border: 2px dashed #ccc;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: #fafafa;
            border-radius: 4px;
        }

        .file-upload-area:hover {
            border-color: #2e7d32;
            background: #f5fff5;
        }

        .file-upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: #2e7d32;
        }

        .file-list {
            margin-top: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            margin-bottom: 4px;
            border-radius: 3px;
        }

        .file-item .file-name {
            flex: 1;
        }

        .file-item .file-remove {
            color: #c00;
            cursor: pointer;
        }

        /* Parts Used Section Styles */
        .parts-subtabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f5f5f5;
            margin-bottom: 12px;
        }

        .parts-subtab {
            padding: 10px 20px;
            font-size: 12px;
            color: #333;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .parts-subtab:hover {
            background: #e8e8e8;
        }

        .parts-subtab.active {
            color: #0066cc;
            font-weight: bold;
            border-bottom-color: #0066cc;
            background: #fff;
        }

        .parts-tab-content {
            display: none;
        }

        .parts-tab-content.active {
            display: block;
        }

        .parts-table-container {
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .parts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 1200px;
        }

        .parts-table th {
            background: #e8f0f8;
            border: 1px solid #ccc;
            padding: 8px 6px;
            text-align: left;
            font-weight: normal;
            color: #0066cc;
            white-space: nowrap;
            font-size: 10px;
        }

        /* File Input Styles */
        .file-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .file-input-wrapper .file-name-input {
            padding-right: 25px;
            cursor: pointer;
        }

        .file-input-wrapper .file-dropdown-icon {
            position: absolute;
            right: 8px;
            color: #666;
            pointer-events: none;
            font-size: 10px;
        }

        .files-table .form-input[disabled] {
            background: repeating-linear-gradient(
                -45deg,
                #f5f5f5,
                #f5f5f5 5px,
                #e8e8e8 5px,
                #e8e8e8 10px
            );
            cursor: not-allowed;
        }

        .required-star {
            color: #c00;
        }

        .parts-table td {
            border: 1px solid #ddd;
            padding: 4px;
            vertical-align: top;
        }

        .parts-table .form-input {
            width: 100%;
            padding: 4px 6px;
            font-size: 11px;
            border: 1px solid #ccc;
        }

        .parts-input-row {
            background: #fffde7;
            border-left: 3px solid #ffc107;
        }

        .parts-saved-row {
            background: #fff;
            cursor: pointer;
            transition: background 0.15s;
        }

        .parts-saved-row:hover {
            background: #f5f5f5;
        }

        .selected-row {
            background: #e3f2fd !important;
            border-left: 3px solid #1976d2;
        }

        .parts-data-row {
            background: #fff;
        }

        .parts-data-row:hover {
            background: #f5f5f5;
        }

        .parts-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: #f0f0f0;
            border: 1px solid #ddd;
        }

        /* SKU Autocomplete Styles */
        .sku-autocomplete {
            position: relative;
        }

        .sku-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .sku-dropdown.show {
            display: block;
        }

        .sku-option, .sku-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #eee;
        }

        .sku-item:hover {
            background: #e8f5e9;
        }

        .sku-option:hover {
            background: #e8f5e9;
        }

        .sku-option .sku-code {
            font-weight: bold;
            color: #0066cc;
        }

        .sku-option .sku-name {
            color: #666;
            margin-left: 8px;
        }

        /* Gas Summary Section */
        .gas-summary-section {
            margin-bottom: 20px;
        }

        .gas-summary-title {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="oracle-netsuite-logo">
                <span class="oracle-text">ORACLE</span>
                <span class="netsuite-text">NetSuite</span>
            </div>
            <div class="picarro-logo">PICARRO</div>
            <div class="sandbox-badge">SANDBOX</div>
            <div class="search-box">
                <input type="text" placeholder="Search">
                <span>üîç</span>
            </div>
        </div>
        <div class="top-bar-right">
            <span class="help-link">üîî</span>
            <span class="help-link">‚ùì Help</span>
            <span class="feedback-link">‚úèÔ∏è Feedback</span>
            <div class="user-info">
                <div class="user-name">Qureshi, Daanyaal N</div>
                <div class="user-company">Picarro, Inc. ¬∑ Picarro Support - Industrial</div>
            </div>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="main-nav">
        <span class="nav-icon">‚Ü©Ô∏è</span>
        <span class="nav-icon">‚≠ê</span>
        <span class="nav-icon">üè†</span>
        <span class="nav-item">Activities</span>
        <span class="nav-item active">Cases</span>
        <span class="nav-item">Customers</span>
        <span class="nav-item">Reports</span>
        <span class="nav-item">Analytics</span>
        <span class="nav-item">Documents</span>
        <span class="nav-item">Setup</span>
        <span class="nav-item">Support</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <div class="page-title-icon">üìã</div>
            <h1>Case</h1>
            <button class="btn-generate-report" onclick="generateServiceReport()">üìÑ Generate Service Report</button>
            <button class="btn-generate-report" onclick="clearSavedData()" style="background: #d32f2f; margin-left: 5px;" title="Clear all saved form data">üóëÔ∏è Clear Saved Data</button>
            <span class="search-icon">üîç</span>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <div class="page-actions">
                <button class="btn-save" onclick="saveForm()">Save</button>
                <button class="btn-save-dropdown" onclick="toggleSaveMenu(event)">‚ñº</button>
                <button class="btn-cancel" onclick="cancelForm()">Cancel</button>
            </div>
            <div class="right-panel-actions">
                <span>List</span>
                <span>Search</span>
                <span>More</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="form-container">
            <!-- Primary Information Section -->
            <div class="form-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-toggle">‚ñº</span>
                    <span class="section-title">Primary Information</span>
                </div>
                <div class="section-content">
                    <!-- Row 1 -->
                    <div class="form-group">
                        <label class="form-label required">Custom Form</label>
                        <select class="form-select" id="customForm">
                            <option value="picarro-environmental">Picarro Case Form, Environmental</option>
                            <option value="picarro-industrial" selected>Picarro Case Form, Industrial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Assigned To</label>
                        <select class="form-select" id="assignedTo">
                            <option value="">-- Select --</option>
                            <option value="chopp-aaron">Chopp, Aaron</option>
                            <option value="mcdonald-michael">McDonald, Michael</option>
                            <option value="miller-dave">Miller, Dave</option>
                            <option value="qureshi-daanyaal">Qureshi, Daanyaal</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Status</label>
                        <select class="form-select" id="status">
                            <option value="new">New</option>
                            <option value="open">Open</option>
                            <option value="in-progress">In Progress</option>
                            <option value="pending-customer">Pending Customer</option>
                            <option value="escalated">Escalated</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>

                    <!-- Row 2 -->
                    <div class="form-group">
                        <label class="form-label">Number</label>
                        <input type="text" class="form-input readonly" value="To Be Generated" readonly id="caseNumber">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <select class="form-select" id="contact" disabled title="Auto-populated from Company">
                            <option value="">-- Select --</option>
                            <option value="cu20602">CU20602 Midwest Sterilization Corporation</option>
                            <option value="cu23744">CU23744 Becton Dickinson</option>
                            <option value="other">Other Contact</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>

                    <!-- Row 3 -->
                    <div class="form-group">
                        <label class="form-label required">Subject</label>
                        <input type="text" class="form-input" id="subject" value="CEMS Sample line needs to be adjusted">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email" value="JoyW@midweststerilization.com">
                    </div>
                    <div class="form-group">
                        <!-- Empty placeholder -->
                    </div>

                    <!-- Row 4 -->
                    <div class="form-group">
                        <label class="form-label required">Company</label>
                        <select class="form-select" id="company">
                            <option value="">-- Select --</option>
                            <option value="cu20602">CU20602 Midwest Sterilization Corporation</option>
                            <option value="cu23744">CU23744 Becton Dickinson</option>
                            <option value="other">Other Company</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="phone" value="(573) 243-8456">
                    </div>
                    <div class="form-group">
                        <!-- Empty placeholder -->
                    </div>

                    <!-- Row 5 -->
                    <div class="form-group">
                        <label class="form-label required">Profile</label>
                        <select class="form-select" id="profile">
                            <option value="">-- Select --</option>
                            <option value="environmental">Picarro Environmental</option>
                            <option value="industrial">Picarro Industrial</option>
                            <option value="research">Picarro Research</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <!-- Empty placeholder -->
                    </div>
                    <div class="form-group">
                        <!-- Empty placeholder -->
                    </div>
                </div>
            </div>

            <!-- Incident Information Section -->
            <div class="form-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-toggle">‚ñº</span>
                    <span class="section-title">Incident Information</span>
                </div>
                <div class="section-content">
                    <!-- Row 1 -->
                    <div class="form-group">
                        <label class="form-label required">Issue Reported Date</label>
                        <input type="date" class="form-input" id="issueReportedDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Cabinet SN (Required)</label>
                        <div class="autocomplete-input">
                            <input type="text" class="form-input" id="cabinetSn" placeholder="<Type then tab>">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Was system put into maintenance mode</label>
                        <select class="form-select" id="maintenanceMode">
                            <option value="">-- Select --</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>

                    <!-- Row 2 -->
                    <div class="form-group">
                        <label class="form-label required">Service Start Date</label>
                        <input type="date" class="form-input" id="serviceStartDate" value="2026-01-21">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Analyzer SN (If being serviced)</label>
                        <div class="autocomplete-input">
                            <input type="text" class="form-input" id="analyzerSn" placeholder="<Type then tab>">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Calibrations failed before or during service</label>
                        <select class="form-select" id="calibrationsFailed">
                            <option value="">-- Select --</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>

                    <!-- Row 3 -->
                    <div class="form-group">
                        <label class="form-label required">Service Completed Date</label>
                        <input type="date" class="form-input" id="serviceCompletedDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Component SN (Non-Analyzer Part Being Serviced)</label>
                        <input type="text" class="form-input" id="componentSn">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Case Issue</label>
                        <select class="form-select" id="caseIssue">
                            <option value="">-- Select --</option>
                            <option value="cems-ancillary">CEMS Ancillary Equipment</option>
                            <option value="cems-mechanical">CEMS Mechanical Component</option>
                            <option value="cems-software">CEMS Software</option>
                            <option value="wms-individual">WMS Individual Component Failure</option>
                            <option value="wms-multiport">WMS Multi-port Manifold</option>
                            <option value="wms-software">WMS Software</option>
                            <option value="cga">CGA</option>
                        </select>
                    </div>

                    <!-- Row 4 -->
                    <div class="form-group">
                        <label class="form-label required">Type of Service</label>
                        <select class="form-select" id="typeOfService">
                            <option value="">-- Select --</option>
                            <option value="issue-driven-maintenance">Issue-Driven Maintenance Intervention</option>
                            <option value="preventative-maintenance">Preventative Maintenance</option>
                            <option value="issue-driven-and-preventative">Issue-Driven and Preventative Maintenance</option>
                            <option value="qa-qc">QA/QC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Software Version (DCU, etc.)</label>
                        <input type="text" class="form-input" id="softwareVersion">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Case Issue [Secondary]</label>
                        <select class="form-select" id="caseIssueSecondary">
                            <option value="">-- Select Case Issue first --</option>
                        </select>
                    </div>

                    <!-- Row 5 -->
                    <div class="form-group">
                        <label class="form-label">In Person or Remote</label>
                        <select class="form-select" id="inPersonOrRemote">
                            <option value="">-- Select --</option>
                            <option value="in-person">In Person</option>
                            <option value="remote">Remote</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sampling Location (if applicable)</label>
                        <input type="text" class="form-input" id="samplingLocation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Case Issue [Alternate]</label>
                        <textarea class="form-textarea" id="caseIssueAlternate" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <!-- Tabs Section -->
            <div class="form-tabs">
                <div class="form-tab active" onclick="switchTab(this, 'related-records')">Related Records & Summary</div>
                <div class="form-tab" onclick="switchTab(this, 'downtime')">Downtime</div>
                <div class="form-tab" onclick="switchTab(this, 'reports-files')">Reports & Files</div>
                <div class="form-tab" onclick="switchTab(this, 'parts-used')">Parts Used</div>
                <div class="form-tab" onclick="switchTab(this, 'communication')">Communication</div>
                <div class="form-tab" onclick="switchTab(this, 'address')">Address</div>
                <div class="form-tab" onclick="switchTab(this, 'escalations')">Escalations</div>
                <div class="form-tab" onclick="switchTab(this, 'system-info')">System Information</div>
                <div class="tab-menu-icon">‚ò∞</div>
            </div>

            <!-- Tab Contents -->
            <div id="related-records" class="tab-content active">
                <!-- Summary Section -->
                <div class="tab-section">
                    <div class="tab-section-header" onclick="toggleTabSection(this)">
                        <span class="section-toggle">‚ñº</span>
                        <span class="tab-section-title">Summary</span>
                    </div>
                    <div class="tab-section-content">
                        <div class="summary-grid">
                            <div class="summary-left">
                                <div class="form-group">
                                    <label class="form-label required">Description of Issue</label>
                                    <textarea class="form-textarea" id="descriptionOfIssue" rows="8" style="width: 100%;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Description of Maintenance</label>
                                    <textarea class="form-textarea" id="descriptionOfMaintenance" rows="8" style="width: 100%;"></textarea>
                                </div>
                            </div>
                            <div class="summary-right">
                                <div class="form-group">
                                    <label class="form-label required">Was the problem resolved</label>
                                    <select class="form-select" id="resolution">
                                        <option value="">-- Select --</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Incident Origin</label>
                                    <select class="form-select" id="incidentOrigin">
                                        <option value="">-- Select --</option>
                                        <option value="site-operational">Site / Operational Factors</option>
                                        <option value="installation-service">Installation or Service Execution</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Related RMA Number</label>
                                    <div class="autocomplete-input">
                                        <input type="text" class="form-input" id="relatedRmaNumber" placeholder="<Type then tab>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">System passed QA/QC</label>
                                    <select class="form-select" id="systemPassedQaQc">
                                        <option value="">-- Select --</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calibration Gas Summary Section -->
                <div class="tab-section">
                    <div class="tab-section-header-solid">
                        <span class="tab-section-title">Calibration Gas Summary</span>
                    </div>
                    <div class="tab-section-content">
                        <div class="gas-summary-section">
                            <div class="parts-table-container">
                                <table class="parts-table">
                                    <thead>
                                        <tr>
                                            <th>GAS TYPE</th>
                                            <th>CYLINDER NUMBER</th>
                                            <th>EXPIRATION DATE</th>
                                            <th>CONCENTRATION</th>
                                            <th>PRESSURE AS FOUND (PSI)</th>
                                            <th>PRESSURE AS LEFT (PSI)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calibrationGasBody">
                                        <tr class="parts-input-row">
                                            <td><input type="text" class="form-input"></td>
                                            <td><input type="text" class="form-input"></td>
                                            <td><input type="date" class="form-input"></td>
                                            <td><input type="text" class="form-input"></td>
                                            <td><input type="number" class="form-input"></td>
                                            <td><input type="number" class="form-input"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="parts-actions">
                                <button class="btn-action btn-primary" onclick="addTableRow('calibrationGasBody', 'calibrationGas')">‚úì Add</button>
                                <button class="btn-action" onclick="cancelTableRow('calibrationGasBody')">‚úó Cancel</button>
                                <button class="btn-action" onclick="insertTableRow('calibrationGasBody', 'calibrationGas')">+ Insert</button>
                                <button class="btn-action" onclick="removeTableRow('calibrationGasBody')">üóë Remove</button>
                                <button class="btn-action" onclick="moveTableRow('calibrationGasBody', 'up')">‚Üë Move Up</button>
                                <button class="btn-action" onclick="moveTableRow('calibrationGasBody', 'down')">‚Üì Move Down</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Downtime Tab -->
            <div id="downtime" class="tab-content">
                <div class="tab-section">
                    <div class="tab-section-header" onclick="toggleTabSection(this)">
                        <span class="section-toggle">‚ñº</span>
                        <span class="tab-section-title">System Downtime</span>
                    </div>
                    <div class="tab-section-content">
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="form-group">
                                <label class="form-label">Time system entered maintenance mode</label>
                                <input type="datetime-local" class="form-input" id="maintenanceEntryTime">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End time of passed system calibration</label>
                                <input type="datetime-local" class="form-input" id="maintenanceExitTime">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Downtime for system</label>
                                <input type="text" class="form-input" id="totalDowntime" readonly placeholder="Auto-calculated" style="background-color: #f5f5f5;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports & Files Tab -->
            <div id="reports-files" class="tab-content">
                <!-- Remove All Button -->
                <div style="margin-bottom: 10px;">
                    <button class="btn-action" onclick="removeAllFiles('reportsFilesBody')">Remove all</button>
                </div>
                
                <!-- Files Table -->
                <div class="parts-table-container">
                    <table class="parts-table files-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">ATTACH FILE <span class="required-star">*</span></th>
                                <th style="width: 20%;">FOLDER</th>
                                <th style="width: 10%;">SIZE (KB)</th>
                                <th style="width: 15%;">LAST MODIFIED</th>
                                <th style="width: 15%;">FILE TYPE</th>
                            </tr>
                        </thead>
                        <tbody id="reportsFilesBody">
                            <tr class="parts-input-row">
                                <td>
                                    <div class="file-input-wrapper">
                                        <input type="text" class="form-input file-name-input" placeholder="<Type then tab>" readonly onclick="this.nextElementSibling.click()">
                                        <input type="file" class="hidden-file-input" style="display: none;" onchange="handleFileSelect(this)">
                                        <span class="file-dropdown-icon">‚ñº</span>
                                    </div>
                                </td>
                                <td><input type="text" class="form-input" disabled></td>
                                <td><input type="text" class="form-input" disabled></td>
                                <td><input type="text" class="form-input" disabled></td>
                                <td><input type="text" class="form-input" disabled></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="parts-actions">
                    <button class="btn-action btn-primary" onclick="addFileRow('reportsFilesBody')">‚úì Add</button>
                    <button class="btn-action" onclick="cancelFileRow('reportsFilesBody')">‚úó Cancel</button>
                    <button class="btn-action" onclick="insertFileRow('reportsFilesBody')">+ Insert</button>
                    <button class="btn-action" onclick="removeFileRow('reportsFilesBody')">üóë Remove</button>
                </div>
            </div>

            <!-- Parts Used Tab -->
            <div id="parts-used" class="tab-content">
                <!-- Parts Used Sub-tabs -->
                <div class="parts-subtabs">
                    <div class="parts-subtab active" onclick="switchPartsTab(this, 'inventory')">Inventory Spares</div>
                    <div class="parts-subtab" onclick="switchPartsTab(this, 'non-inventory')">Non-Inventory Spares</div>
                </div>

                <!-- Inventory Spares Tab -->
                <div id="parts-inventory" class="parts-tab-content active">
                    <div class="parts-table-container">
                        <table class="parts-table">
                            <thead>
                                <tr>
                                    <th>ITEM (SKU)</th>
                                    <th>DESCRIPTION</th>
                                    <th>QUANTITY</th>
                                    <th>UNIT PRICE</th>
                                    <th>EXTENDED AMOUNT</th>
                                    <th>ORIGINAL SERIAL NUMBER</th>
                                    <th>NEW SERIAL NUMBER</th>
                                    <th>AVAILABLE QTY</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryPartsBody">
                                <tr class="parts-input-row">
                                    <td>
                                        <div class="sku-autocomplete">
                                            <input type="text" class="form-input sku-input" placeholder="<Type then tab>" autocomplete="off">
                                            <div class="sku-dropdown"></div>
                                        </div>
                                    </td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="number" class="form-input qty-input" style="width: 60px;" oninput="calculateExtendedAmount(this)"></td>
                                    <td><input type="number" class="form-input price-input" style="width: 80px;" oninput="calculateExtendedAmount(this)"></td>
                                    <td><input type="text" class="form-input extended-amount" style="width: 80px;" readonly></td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="text" class="form-input" style="width: 80px;" readonly></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="parts-actions">
                        <button class="btn-action btn-primary" onclick="addTableRow('inventoryPartsBody', 'inventory')">‚úì Add</button>
                        <button class="btn-action" onclick="cancelTableRow('inventoryPartsBody')">‚úó Cancel</button>
                        <button class="btn-action" onclick="insertTableRow('inventoryPartsBody', 'inventory')">+ Insert</button>
                        <button class="btn-action" onclick="removeTableRow('inventoryPartsBody')">üóë Remove</button>
                        <button class="btn-action" onclick="moveTableRow('inventoryPartsBody', 'up')">‚Üë Move Up</button>
                        <button class="btn-action" onclick="moveTableRow('inventoryPartsBody', 'down')">‚Üì Move Down</button>
                        <button class="btn-action" onclick="moveTableRow('inventoryPartsBody', 'top')">‚áà Move To Top</button>
                        <button class="btn-action" onclick="moveTableRow('inventoryPartsBody', 'bottom')">‚áä Move To Bottom</button>
                    </div>
                </div>

                <!-- Non-Inventory Spares Tab -->
                <div id="parts-non-inventory" class="parts-tab-content">
                    <div class="parts-table-container">
                        <table class="parts-table">
                            <thead>
                                <tr>
                                    <th>ITEM</th>
                                    <th>VENDOR NAME</th>
                                    <th>PR VENDOR PART #</th>
                                    <th>DESCRIPTION</th>
                                    <th>QUANTITY</th>
                                    <th>UNIT PRICE</th>
                                    <th>EXTENDED AMOUNT</th>
                                    <th>ORIGINAL SERIAL NUMBER</th>
                                    <th>NEW SERIAL NUMBER</th>
                                </tr>
                            </thead>
                            <tbody id="nonInventoryPartsBody">
                                <tr class="parts-input-row">
                                    <td>
                                        <div class="autocomplete-input">
                                            <input type="text" class="form-input" placeholder="<Type then tab>">
                                        </div>
                                    </td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="number" class="form-input qty-input" style="width: 60px;" oninput="calculateExtendedAmount(this)"></td>
                                    <td><input type="number" class="form-input price-input" style="width: 80px;" oninput="calculateExtendedAmount(this)"></td>
                                    <td><input type="text" class="form-input extended-amount" style="width: 80px;" readonly></td>
                                    <td><input type="text" class="form-input"></td>
                                    <td><input type="text" class="form-input"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="parts-actions">
                        <button class="btn-action btn-primary" onclick="addTableRow('nonInventoryPartsBody', 'nonInventory')">‚úì Add</button>
                        <button class="btn-action" onclick="cancelTableRow('nonInventoryPartsBody')">‚úó Cancel</button>
                        <button class="btn-action" onclick="insertTableRow('nonInventoryPartsBody', 'nonInventory')">+ Insert</button>
                        <button class="btn-action" onclick="removeTableRow('nonInventoryPartsBody')">üóë Remove</button>
                        <button class="btn-action" onclick="moveTableRow('nonInventoryPartsBody', 'up')">‚Üë Move Up</button>
                        <button class="btn-action" onclick="moveTableRow('nonInventoryPartsBody', 'down')">‚Üì Move Down</button>
                        <button class="btn-action" onclick="moveTableRow('nonInventoryPartsBody', 'top')">‚áà Move To Top</button>
                        <button class="btn-action" onclick="moveTableRow('nonInventoryPartsBody', 'bottom')">‚áä Move To Bottom</button>
                    </div>
                </div>
            </div>
            <div id="communication" class="tab-content">
                <!-- Communication Sub-tabs -->
                <div class="comm-subtabs">
                    <div class="comm-subtab active">Messages</div>
                    <div class="comm-subtab">Activities</div>
                    <div class="comm-subtab">Files</div>
                    <div class="comm-subtab">User Notes</div>
                    <div class="comm-subtab">Tasks</div>
                    <div class="comm-subtab">Events</div>
                    <div class="comm-subtab">Calls</div>
                </div>

                <!-- View Dropdown -->
                <div class="comm-view-section">
                    <label class="form-label">VIEW</label>
                    <select class="form-select" id="commView" style="width: 150px;">
                        <option value="case-default">Case Default</option>
                        <option value="all">All</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="comm-actions">
                    <button class="btn-action">Email</button>
                    <button class="btn-action">Attach</button>
                    <button class="btn-action btn-primary">Refresh</button>
                    <button class="btn-action">View History</button>
                    <button class="btn-action">Customize View</button>
                </div>

                <!-- Messages Table -->
                <div class="comm-table-container">
                    <table class="comm-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>VIEW</th>
                                <th>DATE</th>
                                <th>AUTHOR</th>
                                <th>MESSAGE</th>
                                <th>EMAIL SENT</th>
                                <th>PRIMARY RECIPIENT</th>
                                <th>CC</th>
                                <th>FILES</th>
                                <th>ATTACHMENTS</th>
                                <th>INTERNAL ONLY</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="11" class="no-records">No records to show.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="address" class="tab-content">
                <!-- Shipping Address Section -->
                <div class="address-section">
                    <div class="address-section-header">Shipping Address</div>
                    <div class="address-content">
                        <div class="address-row">
                            <label class="address-label">SHIP TO SELECT</label>
                            <select class="form-select address-select" id="shipToSelect" onchange="updateShipToAddress()">
                                <option value="">-- Select Address --</option>
                                <option value="1204-lenco" selected>1204 Lenco Avenue</option>
                                <option value="custom">Custom Address...</option>
                            </select>
                        </div>
                        <div class="address-row">
                            <label class="address-label">SHIP TO</label>
                            <div class="address-display" id="shipToDisplay">
                                <div class="address-text" id="shipToAddress">
                                    <div>Midwest Sterilization Corporation</div>
                                    <div>1204 Lenco Avenue</div>
                                    <div>Jackson MO 63755</div>
                                    <div>United States</div>
                                    <div>(573) 243-8456</div>
                                </div>
                                <a href="#" class="address-map-link" onclick="openMap()">üìç Map</a>
                            </div>
                        </div>
                        <div class="address-row" style="margin-top: 30px;">
                            <label class="address-label">SHIPPING CODE (2)</label>
                            <select class="form-select address-select" id="shippingCode">
                                <option value="">-- Select --</option>
                                <option value="ground">Ground</option>
                                <option value="express">Express</option>
                                <option value="overnight">Overnight</option>
                                <option value="freight">Freight</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="escalations" class="tab-content">
                <div class="communication-content">
                    <p>No escalations recorded for this case.</p>
                </div>
            </div>
            <div id="system-info" class="tab-content">
                <div class="communication-content">
                    <p>System information will be populated after case creation.</p>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="footer-actions">
                <button class="btn-save" onclick="saveForm()">Save</button>
                <button class="btn-save-dropdown" onclick="toggleSaveMenu(event)">‚ñº</button>
                <button class="btn-cancel" onclick="cancelForm()">Cancel</button>
            </div>
        </div>

    </div>

    <!-- File Drop Area (Fixed position top right) -->
    <div class="file-drop-area" id="fileDropArea">
        <div class="file-drop-icon">üìé</div>
        <p>Drop files</p>
        <input type="file" id="fileInput" style="display: none;" multiple>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <button class="sidebar-btn" title="Help">‚ùì</button>
        <button class="sidebar-btn" title="Settings">‚öôÔ∏è</button>
    </div>

    <!-- Save Dropdown Menu -->
    <div class="dropdown-menu" id="saveDropdown">
        <div class="dropdown-item" onclick="saveAndNew()">Save & New</div>
        <div class="dropdown-item" onclick="saveAndEmail()">Save & Email</div>
        <div class="dropdown-item" onclick="saveAndPrint()">Save & Print</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Store attached files for PDF generation
        const attachedFiles = {
            calibration: [],
            cga: [],
            general: []
        };
        
        // Store files from Reports & Files table
        const reportsFilesStore = new Map();

        // ==================== LOCAL STORAGE PERSISTENCE ====================
        const STORAGE_KEY = 'netsuite_case_form_data';

        // List of form field IDs to save
        const formFieldIds = [
            'customForm', 'assignedTo', 'caseNumber', 'status', 'priority', 'company', 
            'contact', 'email', 'phone', 'profile', 'subject', 'issueReportedDate',
            'serviceStartDate', 'serviceCompletedDate', 'maintenanceMode', 'calibrationsFailed',
            'cabinetSn', 'analyzerSn', 'componentSn', 'softwareVersion', 'samplingLocation',
            'caseIssue', 'caseIssueSecondary', 'caseIssueAlternate', 'typeOfService', 'inPersonOrRemote',
            'descriptionOfIssue', 'descriptionOfMaintenance', 'resolution', 'incidentOrigin',
            'relatedRmaNumber', 'systemPassedQaQc', 'shipToSelect', 'shippingCode',
            'maintenanceEntryTime', 'maintenanceExitTime', 'totalDowntime'
        ];

        // Save form data to localStorage
        function saveFormData() {
            try {
                const formData = {};
                
                formFieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        formData[id] = el.value;
                    }
                });

                // Save table data (Parts Used)
                formData.inventoryParts = getTableData('inventoryPartsBody');
                formData.nonInventoryParts = getTableData('nonInventoryPartsBody');
                formData.calibrationGas = getTableData('calibrationGasBody');

                localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
                console.log('Form data saved to localStorage');
            } catch (e) {
                console.error('Error saving form data:', e);
            }
        }

        // Clear all saved form data and reset form/tables on screen
        function clearSavedData() {
            localStorage.removeItem(STORAGE_KEY);

            // Clear all form fields
            formFieldIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                }
            });

            // Reset Case Issue [Secondary] options and value
            const caseIssueEl = document.getElementById('caseIssue');
            if (caseIssueEl) {
                caseIssueEl.dispatchEvent(new Event('change'));
            }

            // Clear tables: remove saved rows and clear the input row
            function clearTableToSingleRow(tableBodyId, tableType) {
                const tbody = document.getElementById(tableBodyId);
                if (!tbody) return;
                const savedRows = tbody.querySelectorAll('tr.parts-saved-row');
                savedRows.forEach(row => row.remove());
                const inputRow = tbody.querySelector('tr.parts-input-row');
                if (inputRow) {
                    inputRow.querySelectorAll('input, select, textarea').forEach(inp => {
                        if (inp.type === 'checkbox') inp.checked = false;
                        else inp.value = '';
                    });
                }
            }

            clearTableToSingleRow('inventoryPartsBody', 'inventory');
            clearTableToSingleRow('nonInventoryPartsBody', 'nonInventory');
            clearTableToSingleRow('calibrationGasBody', 'calibrationGas');

            // Clear Reports & Files table and file store
            reportsFilesStore.clear();
            const reportsBody = document.getElementById('reportsFilesBody');
            if (reportsBody) {
                const savedFileRows = reportsBody.querySelectorAll('tr.saved-row');
                savedFileRows.forEach(row => row.remove());
                const inputRow = reportsBody.querySelector('tr.parts-input-row');
                if (inputRow) {
                    inputRow.querySelectorAll('input').forEach(inp => {
                        if (inp.type === 'file') inp.value = '';
                        else inp.value = '';
                    });
                    const nameInput = inputRow.querySelector('.file-name-input');
                    if (nameInput) {
                        nameInput.value = '';
                        nameInput.removeAttribute('data-file-id');
                        nameInput.removeAttribute('data-file-data');
                    }
                }
            }

            // Clear row selection state
            selectedRows.inventoryPartsBody = null;
            selectedRows.nonInventoryPartsBody = null;
            selectedRows.calibrationGasBody = null;

            // Clear total downtime (calculated field)
            const totalDowntimeEl = document.getElementById('totalDowntime');
            if (totalDowntimeEl) totalDowntimeEl.value = '';

            // Flag so that on next page load we don't repopulate default dates
            sessionStorage.setItem('netsuite_form_cleared', '1');

            showNotification('Saved data cleared. Form reset.');
        }

        // Get table data as array
        function getTableData(tableBodyId) {
            const rows = [];
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return rows;

            tbody.querySelectorAll('tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.type === 'checkbox') {
                        rowData.push(input.checked);
                    } else {
                        rowData.push(input.value);
                    }
                });
                if (rowData.some(v => v !== '' && v !== false)) {
                    rows.push(rowData);
                }
            });
            return rows;
        }

        // Load form data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;

            try {
                const formData = JSON.parse(savedData);

                formFieldIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && formData[id] !== undefined) {
                        el.value = formData[id];
                    }
                });

                // Trigger change event on caseIssue to populate secondary options
                const caseIssueEl = document.getElementById('caseIssue');
                if (caseIssueEl && formData.caseIssue) {
                    caseIssueEl.dispatchEvent(new Event('change'));
                    // Set secondary value after options are populated
                    setTimeout(() => {
                        const secondaryEl = document.getElementById('caseIssueSecondary');
                        if (secondaryEl && formData.caseIssueSecondary) {
                            secondaryEl.value = formData.caseIssueSecondary;
                        }
                    }, 50);
                }

                // Load table data
                if (formData.inventoryParts) {
                    loadTableData('inventoryPartsBody', formData.inventoryParts);
                }
                if (formData.nonInventoryParts) {
                    loadTableData('nonInventoryPartsBody', formData.nonInventoryParts);
                }
                if (formData.calibrationGas) {
                    loadTableData('calibrationGasBody', formData.calibrationGas);
                }

            } catch (e) {
                console.error('Error loading form data:', e);
            }
        }

        // Load table data from saved array
        function loadTableData(tableBodyId, data) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody || !data || data.length === 0) return;

            const firstRow = tbody.querySelector('tr');
            if (!firstRow) return;

            // Load data into first row
            if (data[0]) {
                const inputs = firstRow.querySelectorAll('input, select, textarea');
                data[0].forEach((value, index) => {
                    if (inputs[index]) {
                        if (inputs[index].type === 'checkbox') {
                            inputs[index].checked = value;
                        } else {
                            inputs[index].value = value;
                        }
                    }
                });
            }
        }

        // Setup auto-save on any form field change
        function setupAutoSave() {
            // Add listeners to all form inputs
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('change', saveFormData);
                el.addEventListener('input', debounce(saveFormData, 500));
            });
        }

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Load form data on page load - use DOMContentLoaded for faster loading
        document.addEventListener('DOMContentLoaded', () => {
            // First load any saved data
            loadFormData();

            // If user had clicked "Clear Saved Data" before refreshing, don't fill default dates
            const wasCleared = sessionStorage.getItem('netsuite_form_cleared');
            if (wasCleared) {
                sessionStorage.removeItem('netsuite_form_cleared');
            } else {
                // Set defaults for fields that are still empty
                setDefaultValues();
            }
            
            // Finally setup auto-save
            setupAutoSave();
            
            // Setup downtime calculation
            setupDowntimeCalculation();
            
            console.log('Form data loaded from localStorage');
        });

        // Set default values only for empty fields
        function setDefaultValues() {
            const serviceStartEl = document.getElementById('serviceStartDate');
            if (serviceStartEl && !serviceStartEl.value) {
                serviceStartEl.value = new Date().toISOString().split('T')[0];
            }
            
            const issueReportedEl = document.getElementById('issueReportedDate');
            if (issueReportedEl && !issueReportedEl.value) {
                issueReportedEl.value = new Date().toISOString().split('T')[0];
            }
        }

        // Calculate total downtime based on entry and exit times
        function calculateDowntime() {
            const entryTime = document.getElementById('maintenanceEntryTime').value;
            const exitTime = document.getElementById('maintenanceExitTime').value;
            const totalDowntimeEl = document.getElementById('totalDowntime');
            
            if (entryTime && exitTime) {
                const entry = new Date(entryTime);
                const exit = new Date(exitTime);
                const diffMs = exit - entry;
                
                if (diffMs < 0) {
                    totalDowntimeEl.value = 'Invalid (exit before entry)';
                    return;
                }
                
                // Calculate days, hours, minutes
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const days = Math.floor(diffMinutes / (60 * 24));
                const hours = Math.floor((diffMinutes % (60 * 24)) / 60);
                const minutes = diffMinutes % 60;
                
                let result = '';
                if (days > 0) {
                    result += days + ' day' + (days > 1 ? 's' : '') + ' ';
                }
                if (hours > 0 || days > 0) {
                    result += hours + ' hour' + (hours !== 1 ? 's' : '') + ' ';
                }
                result += minutes + ' minute' + (minutes !== 1 ? 's' : '');
                
                totalDowntimeEl.value = result.trim();
            } else {
                totalDowntimeEl.value = '';
            }
        }

        // Setup downtime calculation listeners
        function setupDowntimeCalculation() {
            const entryTimeEl = document.getElementById('maintenanceEntryTime');
            const exitTimeEl = document.getElementById('maintenanceExitTime');
            
            if (entryTimeEl) {
                entryTimeEl.addEventListener('change', calculateDowntime);
            }
            if (exitTimeEl) {
                exitTimeEl.addEventListener('change', calculateDowntime);
            }
            
            // Recalculate on page load in case values were restored from localStorage
            calculateDowntime();
        }

        // ==================== END LOCAL STORAGE PERSISTENCE ====================

        // Generate Service Report PDF
        async function generateServiceReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            
            // Helper function to get form value
            const getValue = (id) => {
                const el = document.getElementById(id);
                if (!el) return '';
                if (el.tagName === 'SELECT') {
                    return el.options[el.selectedIndex]?.text || '';
                }
                return el.value || '';
            };
            
            // Helper function to add section header
            const addSectionHeader = (text) => {
                doc.setFillColor(200, 200, 200);
                doc.rect(margin, yPos, contentWidth, 7, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(text, pageWidth / 2, yPos + 5, { align: 'center' });
                yPos += 10;
                doc.setFont('helvetica', 'normal');
            };
            
            // Helper function to add label-value pair
            const addField = (label, value, indent = margin) => {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(label + ': ', indent, yPos);
                doc.setFont('helvetica', 'normal');
                const labelWidth = doc.getTextWidth(label + ':  ');
                doc.text(value || 'N/A', indent + labelWidth, yPos);
                yPos += 6;
            };
            
            // Helper to check if we need a new page
            const checkPageBreak = (neededSpace = 20) => {
                if (yPos + neededSpace > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    yPos = 20;
                }
            };

            // ==================== HEADER ====================
            // Picarro Logo/Name
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40, 40, 40);
            doc.text('PICARRO', margin, yPos);
            
            // Field Service Report Title
            doc.setFontSize(16);
            doc.setTextColor(128, 128, 128);
            doc.text('Field Service Report', pageWidth - margin, yPos, { align: 'right' });
            yPos += 8;
            
            // Case Number
            const caseNumber = getValue('caseNumber') || 'CAS00000';
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Case:  ' + caseNumber, pageWidth - margin, yPos, { align: 'right' });
            yPos += 8;
            
            // Company Address
            doc.setFontSize(9);
            doc.setTextColor(60, 60, 60);
            doc.setFont('helvetica', 'normal');
            doc.text('Picarro Inc.', margin, yPos);
            doc.text('Case Status:  ' + (getValue('status') || 'N/A'), pageWidth - margin, yPos, { align: 'right' });
            yPos += 5;
            doc.text('3105 Patrick Henry Drive', margin, yPos);
            doc.text('Date Opened:  ' + (getValue('issueReportedDate') || 'N/A'), pageWidth - margin, yPos, { align: 'right' });
            yPos += 5;
            doc.text('Santa Clara CA 95054-1815', margin, yPos);
            doc.text('Date Closed:  ' + (getValue('serviceCompletedDate') || 'N/A'), pageWidth - margin, yPos, { align: 'right' });
            yPos += 8;
            
            // Case Owner Info
            doc.text('Case Owner:  ' + (getValue('assignedTo') || 'N/A'), margin, yPos);
            yPos += 5;
            doc.text('Email:  support@picarro.com', margin, yPos);
            yPos += 5;
            doc.text('Phone:  1-408-962-3991', margin, yPos);
            yPos += 12;
            
            // ==================== CUSTOMER INFORMATION ====================
            addSectionHeader('Customer Information');
            
            doc.setFontSize(9);
            const custCol1 = margin;
            const custCol2 = pageWidth / 2;
            
            doc.text('Customer:  ' + (getValue('company') || 'N/A'), custCol1, yPos);
            doc.text('Email:  ' + (getValue('email') || 'N/A'), custCol2, yPos);
            yPos += 6;
            doc.text('Contact:  ' + (getValue('contact') || 'N/A'), custCol1, yPos);
            doc.text('Phone:  ' + (getValue('phone') || 'N/A'), custCol2, yPos);
            yPos += 10;
            
            // ==================== SHIPPING ADDRESS ====================
            addSectionHeader('Shipping Address');
            
            const shipToSelect = getValue('shipToSelect');
            if (shipToSelect) {
                const shipToAddress = document.getElementById('shipToAddress');
                if (shipToAddress) {
                    const addressText = shipToAddress.innerText || 'N/A';
                    const addressLines = addressText.split('\n').filter(line => line.trim());
                    addressLines.forEach(line => {
                        doc.text(line.trim(), margin, yPos);
                        yPos += 4;
                    });
                }
            } else {
                doc.text('No shipping address specified', margin, yPos);
                yPos += 4;
            }
            doc.text('Shipping Code:  ' + (getValue('shippingCode') || 'N/A'), margin, yPos);
            yPos += 10;
            
            // ==================== PRODUCT INFORMATION ====================
            addSectionHeader('Product Information');
            
            doc.text('Cabinet SN:  ' + (getValue('cabinetSn') || 'N/A'), custCol1, yPos);
            doc.text('Analyzer SN:  ' + (getValue('analyzerSn') || 'N/A'), custCol2, yPos);
            yPos += 6;
            doc.text('Component SN:  ' + (getValue('componentSn') || 'N/A'), custCol1, yPos);
            doc.text('Software Version:  ' + (getValue('softwareVersion') || 'N/A'), custCol2, yPos);
            yPos += 6;
            doc.text('Sampling Location:  ' + (getValue('samplingLocation') || 'N/A'), custCol1, yPos);
            yPos += 10;
            
            // ==================== CASE INFORMATION ====================
            addSectionHeader('Case Information');
            
            addField('Case Subject', getValue('subject'));
            addField('Type of Service', getValue('typeOfService'));
            addField('In Person or Remote', getValue('inPersonOrRemote'));
            addField('Issue Reported Date', getValue('issueReportedDate'));
            addField('Service Start Date', getValue('serviceStartDate'));
            addField('Service Completed Date', getValue('serviceCompletedDate'));
            addField('Was System in Maintenance Mode', getValue('maintenanceMode'));
            addField('Calibrations Failed', getValue('calibrationsFailed'));
            addField('Primary Issue', getValue('caseIssue'));
            addField('Secondary Issue (if any)', getValue('caseIssueSecondary'));
            addField('Alternate Issue (if any)', getValue('caseIssueAlternate'));
            yPos += 5;
            
            // ==================== SUMMARY ====================
            checkPageBreak(40);
            addSectionHeader('Summary');
            
            // Description of Issue
            doc.setFont('helvetica', 'bold');
            doc.text('Description of Issue:', margin, yPos);
            yPos += 5;
            doc.setFont('helvetica', 'normal');
            const issueText = getValue('descriptionOfIssue') || 'N/A';
            const issueLines = doc.splitTextToSize(issueText, contentWidth);
            doc.text(issueLines, margin, yPos);
            yPos += (issueLines.length * 4) + 5;
            
            // Description of Maintenance
            checkPageBreak(20);
            doc.setFont('helvetica', 'bold');
            doc.text('Description of Maintenance:', margin, yPos);
            yPos += 5;
            doc.setFont('helvetica', 'normal');
            const maintText = getValue('descriptionOfMaintenance') || 'N/A';
            const maintLines = doc.splitTextToSize(maintText, contentWidth);
            doc.text(maintLines, margin, yPos);
            yPos += (maintLines.length * 4) + 5;
            
            addField('Was Problem Resolved', getValue('resolution'));
            addField('Incident Origin', getValue('incidentOrigin'));
            addField('Related RMA Number', getValue('relatedRmaNumber'));
            addField('System passed QA/QC', getValue('systemPassedQaQc'));
            yPos += 5;
            
            // ==================== DOWNTIME ====================
            checkPageBreak(30);
            addSectionHeader('System Downtime');
            
            addField('Maintenance Entry Time', getValue('maintenanceEntryTime'));
            addField('End Time of Passed System Calibration', getValue('maintenanceExitTime'));
            addField('Total Downtime', getValue('totalDowntime'));
            yPos += 5;
            
            // ==================== PARTS USED ====================
            checkPageBreak(40);
            addSectionHeader('Parts Used');
            
            // Inventory Spares Table
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('Inventory Spares:', margin, yPos);
            yPos += 5;
            
            const inventoryData = [];
            const inventoryRows = document.querySelectorAll('#inventoryPartsBody tr');
            inventoryRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const item = cells[0]?.querySelector('input')?.value || '';
                    const description = cells[1]?.querySelector('input')?.value || '';
                    const qty = cells[2]?.querySelector('input')?.value || '';
                    const unitPrice = cells[3]?.querySelector('input')?.value || '';
                    const extAmount = cells[4]?.querySelector('input')?.value || '';
                    const origSN = cells[5]?.querySelector('input')?.value || '';
                    const newSN = cells[6]?.querySelector('input')?.value || '';
                    const availQty = cells[7]?.querySelector('input')?.value || '';
                    
                    if (item || description || qty) {
                        inventoryData.push([item, description, qty, unitPrice, extAmount, origSN, newSN, availQty]);
                    }
                }
            });
            
            if (inventoryData.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Item (SKU)', 'Description', 'Qty', 'Unit Price', 'Ext. Amount', 'Orig. SN', 'New SN', 'Avail Qty']],
                    body: inventoryData,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 1 },
                    headStyles: { fillColor: [100, 100, 100] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 10;
            } else {
                doc.setFont('helvetica', 'italic');
                doc.text('No inventory spares recorded', margin, yPos);
                yPos += 8;
            }
            
            // Non-Inventory Spares Table
            checkPageBreak(30);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('Non-Inventory Spares:', margin, yPos);
            yPos += 5;
            
            const nonInventoryData = [];
            const nonInventoryRows = document.querySelectorAll('#nonInventoryPartsBody tr');
            nonInventoryRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const item = cells[0]?.querySelector('input')?.value || '';
                    const vendorName = cells[1]?.querySelector('input')?.value || '';
                    const vendorPart = cells[2]?.querySelector('input')?.value || '';
                    const description = cells[3]?.querySelector('input')?.value || '';
                    const qty = cells[4]?.querySelector('input')?.value || '';
                    const unitPrice = cells[5]?.querySelector('input')?.value || '';
                    const extAmount = cells[6]?.querySelector('input')?.value || '';
                    const origSN = cells[7]?.querySelector('input')?.value || '';
                    const newSN = cells[8]?.querySelector('input')?.value || '';
                    
                    if (item || description || qty) {
                        nonInventoryData.push([item, vendorName, vendorPart, description, qty, unitPrice, extAmount, origSN, newSN]);
                    }
                }
            });
            
            if (nonInventoryData.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Item', 'Vendor', 'Vendor Part#', 'Description', 'Qty', 'Unit Price', 'Ext. Amount', 'Orig. SN', 'New SN']],
                    body: nonInventoryData,
                    theme: 'grid',
                    styles: { fontSize: 6, cellPadding: 1 },
                    headStyles: { fillColor: [100, 100, 100] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 10;
            } else {
                doc.setFont('helvetica', 'italic');
                doc.text('No non-inventory spares recorded', margin, yPos);
                yPos += 8;
            }
            
            // ==================== REPORTS ====================
            checkPageBreak(40);
            addSectionHeader('Reports');
            
            // Calibration Gas Summary Table
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('Calibration Gas Summary:', margin, yPos);
            yPos += 5;
            
            const gasData = [];
            const gasRows = document.querySelectorAll('#calibrationGasBody tr');
            gasRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const gasType = cells[0]?.querySelector('input')?.value || '';
                    const cylinderNum = cells[1]?.querySelector('input')?.value || '';
                    const expDate = cells[2]?.querySelector('input')?.value || '';
                    const concentration = cells[3]?.querySelector('input')?.value || '';
                    const pressureFound = cells[4]?.querySelector('input')?.value || '';
                    const pressureLeft = cells[5]?.querySelector('input')?.value || '';
                    
                    if (gasType || cylinderNum || concentration) {
                        gasData.push([gasType, cylinderNum, expDate, concentration, pressureFound, pressureLeft]);
                    }
                }
            });
            
            if (gasData.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Gas Type', 'Cylinder #', 'Exp Date', 'Concentration', 'Pressure Found', 'Pressure Left']],
                    body: gasData,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 1 },
                    headStyles: { fillColor: [100, 100, 100] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 10;
            } else {
                doc.setFont('helvetica', 'italic');
                doc.text('No calibration gas data recorded', margin, yPos);
                yPos += 8;
            }
            
            // List attached files with details
            checkPageBreak(40);
            doc.setFont('helvetica', 'bold');
            doc.text('Attached Reports:', margin, yPos);
            yPos += 6;
            doc.setFont('helvetica', 'normal');
            
            let hasAttachments = false;
            let attachmentNumber = 1;
            
            // Collect files from the Reports & Files table using the file store
            const reportsTableFiles = [];
            const reportsRows = document.querySelectorAll('#reportsFilesBody tr.saved-row');
            reportsRows.forEach(row => {
                const fileNameInput = row.querySelector('.file-name-input');
                if (fileNameInput && fileNameInput.dataset.fileId) {
                    const file = reportsFilesStore.get(fileNameInput.dataset.fileId);
                    if (file) {
                        reportsTableFiles.push(file);
                    }
                }
            });
            
            // List files from Reports & Files table
            reportsTableFiles.forEach(file => {
                hasAttachments = true;
                const fileType = file.type === 'application/pdf' ? 'PDF Document' : 
                                file.type.startsWith('image/') ? 'Image' : 'File';
                doc.text(`${attachmentNumber}. ${file.name}`, margin + 5, yPos);
                yPos += 4;
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Type: ${fileType} | Size: ${(file.size / 1024).toFixed(1)} KB | (Full content follows on subsequent pages)`, margin + 10, yPos);
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                yPos += 5;
                attachmentNumber++;
                checkPageBreak(15);
            });
            
            // Also check old attachedFiles storage for backwards compatibility
            ['calibration', 'cga', 'general'].forEach(category => {
                if (attachedFiles[category]) {
                    attachedFiles[category].forEach(file => {
                        hasAttachments = true;
                        const fileType = file.type === 'application/pdf' ? 'PDF Document' : 
                                        file.type.startsWith('image/') ? 'Image' : 'File';
                        doc.text(`${attachmentNumber}. ${file.name}`, margin + 5, yPos);
                        yPos += 4;
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Category: ${category.charAt(0).toUpperCase() + category.slice(1)} | Type: ${fileType} | (Full content follows on subsequent pages)`, margin + 10, yPos);
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;
                        attachmentNumber++;
                        checkPageBreak(15);
                    });
                }
            });
            
            if (!hasAttachments) {
                doc.setFont('helvetica', 'italic');
                doc.text('No files attached', margin, yPos);
            }
            
            // Collect all attached files for embedding
            const allAttachedFiles = [];
            
            // Add files from Reports & Files table
            reportsTableFiles.forEach(file => {
                allAttachedFiles.push({ file, category: 'reports' });
            });
            
            // Add files from old storage for backwards compatibility
            for (const category of ['calibration', 'cga', 'general']) {
                if (attachedFiles[category]) {
                    for (const file of attachedFiles[category]) {
                        allAttachedFiles.push({ file, category });
                    }
                }
            }

            // If there are attached files, merge them into the PDF
            if (allAttachedFiles.length > 0) {
                showNotification('Processing attached files...');
                
                // Get the jsPDF output as array buffer
                const jsPdfOutput = doc.output('arraybuffer');
                
                // Use pdf-lib to merge files
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.load(jsPdfOutput);
                
                for (const { file, category } of allAttachedFiles) {
                    try {
                        const fileData = await readFileAsArrayBuffer(file);
                        
                        if (file.type === 'application/pdf') {
                            // For PDF files - copy all pages directly (no separator page)
                            const attachedPdf = await PDFDocument.load(fileData);
                            const pageIndices = attachedPdf.getPageIndices();
                            const copiedPages = await mergedPdf.copyPages(attachedPdf, pageIndices);
                            
                            // Add all pages from the attached PDF directly
                            copiedPages.forEach(page => {
                                mergedPdf.addPage(page);
                            });
                            
                        } else if (file.type.startsWith('image/')) {
                            // For image files - embed as a full page
                            let image;
                            if (file.type === 'image/png') {
                                image = await mergedPdf.embedPng(fileData);
                            } else if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                                image = await mergedPdf.embedJpg(fileData);
                            } else {
                                // Convert other image types to PNG via canvas
                                const imgDataUrl = await readFileAsDataURL(file);
                                const img = new Image();
                                img.src = imgDataUrl;
                                await new Promise(resolve => { img.onload = resolve; });
                                
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                
                                const pngDataUrl = canvas.toDataURL('image/png');
                                const pngData = await fetch(pngDataUrl).then(r => r.arrayBuffer());
                                image = await mergedPdf.embedPng(pngData);
                            }
                            
                            // Calculate dimensions to fit page while maintaining aspect ratio
                            const imgDims = image.scale(1);
                            const pageWidth = 612; // Letter size width in points
                            const pageHeight = 792; // Letter size height in points
                            const pageMargin = 20;
                            
                            let scale = Math.min(
                                (pageWidth - pageMargin * 2) / imgDims.width,
                                (pageHeight - pageMargin * 2) / imgDims.height
                            );
                            
                            const scaledWidth = imgDims.width * scale;
                            const scaledHeight = imgDims.height * scale;
                            
                            // Add new page with image (no header text, just the image)
                            const imagePage = mergedPdf.addPage([pageWidth, pageHeight]);
                            
                            // Center the image on the page
                            const xPos = (pageWidth - scaledWidth) / 2;
                            const yPos = (pageHeight - scaledHeight) / 2;
                            
                            imagePage.drawImage(image, {
                                x: xPos,
                                y: yPos,
                                width: scaledWidth,
                                height: scaledHeight
                            });
                        }
                    } catch (e) {
                        console.error(`Error adding file ${file.name}:`, e);
                        // Add error page
                        const errorPage = mergedPdf.addPage();
                        const { height } = errorPage.getSize();
                        errorPage.drawText(`Could not embed file: ${file.name}`, {
                            x: 50,
                            y: height - 50,
                            size: 12
                        });
                        errorPage.drawText(`Error: ${e.message}`, {
                            x: 50,
                            y: height - 75,
                            size: 10
                        });
                    }
                }
                
                // Add page numbers to all pages
                const pages = mergedPdf.getPages();
                pages.forEach((page, index) => {
                    const { width, height } = page.getSize();
                    page.drawText(String(index + 1), {
                        x: width - 30,
                        y: 15,
                        size: 9
                    });
                });
                
                // Save merged PDF
                const mergedPdfBytes = await mergedPdf.save();
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Field_Service_Report_${caseNumber}_${new Date().toISOString().split('T')[0]}.pdf`;
                link.click();
                URL.revokeObjectURL(url);
                
            } else {
                // No attached files - just add page numbers and save
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(128, 128, 128);
                    doc.text(String(i), pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                }
                
                const fileName = `Field_Service_Report_${caseNumber}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            }
            
            showNotification('Service Report generated successfully!');
        }
        
        // Helper function to read file as data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Helper function to read file as ArrayBuffer (for pdf-lib)
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Toggle section collapse
        function toggleSection(header) {
            const toggle = header.querySelector('.section-toggle');
            const content = header.nextElementSibling;
            
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Toggle tab section collapse
        function toggleTabSection(header) {
            const toggle = header.querySelector('.section-toggle');
            const content = header.nextElementSibling;
            
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Reports tab switching
        function switchReportsTab(tab, tabId) {
            document.querySelectorAll('.reports-subtab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.reports-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('reports-' + tabId).classList.add('active');
        }

        // Parts tab switching
        function switchPartsTab(tab, tabId) {
            document.querySelectorAll('.parts-subtab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.parts-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('parts-' + tabId).classList.add('active');
        }

        // File upload handling
        function setupFileUpload(inputId, listId, category) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const uploadArea = input.closest('.file-upload-area');
            
            // Handle file input change
            input.addEventListener('change', function() {
                handleFiles(this.files, category, list);
            });

            // Add drag and drop functionality
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#2e7d32';
                    this.style.background = '#e8f5e9';
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#ccc';
                    this.style.background = '#fafafa';
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#ccc';
                    this.style.background = '#fafafa';
                    
                    const files = e.dataTransfer.files;
                    handleFiles(files, category, list);
                });
            }
        }

        // Handle files for attachment
        function handleFiles(files, category, list) {
            for (let file of files) {
                // Check if file already exists
                if (attachedFiles[category].some(f => f.name === file.name)) {
                    showNotification(`File "${file.name}" already attached`, 'error');
                    continue;
                }

                // Store file in attachedFiles for PDF generation
                attachedFiles[category].push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.fileName = file.name;
                
                // Get file size in readable format
                const fileSize = file.size < 1024 ? file.size + ' B' :
                                file.size < 1024 * 1024 ? (file.size / 1024).toFixed(1) + ' KB' :
                                (file.size / (1024 * 1024)).toFixed(1) + ' MB';
                
                // Get file icon based on type
                const fileIcon = file.type === 'application/pdf' ? 'üìï' :
                                file.type.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ';
                
                fileItem.innerHTML = `
                    <span class="file-name">${fileIcon} ${file.name} <small style="color:#888;">(${fileSize})</small></span>
                    <span class="file-remove" onclick="removeFile(this, '${category}', '${file.name}')">‚úó</span>
                `;
                list.appendChild(fileItem);
            }
            if (files.length > 0) {
                showNotification(files.length + ' file(s) attached to ' + category);
                saveFormData();
            }
        }
        
        // Remove file from attachedFiles and DOM
        function removeFile(element, category, fileName) {
            attachedFiles[category] = attachedFiles[category].filter(f => f.name !== fileName);
            element.parentElement.remove();
            showNotification('File removed');
            saveFormData();
        }

        // Initialize file uploads (if any remain)

        // Sample SKU data (in real app, this would come from an API)
        const skuData = [
            { sku: 'S3387', name: 'SRV-IS-CEMS-Bellows Pump, MP F05', availableQty: 25 },
            { sku: 'S3388', name: 'SRV-IS-CEMS-Sample Probe Assembly', availableQty: 12 },
            { sku: 'S3389', name: 'SRV-IS-CEMS-Flow Sensor Module', availableQty: 8 },
            { sku: 'S3390', name: 'SRV-IS-CEMS-Calibration Valve Kit', availableQty: 15 },
            { sku: 'S3391', name: 'SRV-IS-CEMS-MFC Controller', availableQty: 5 },
            { sku: 'S3392', name: 'SRV-IS-CEMS-Vacuum Pump Rebuild Kit', availableQty: 20 },
            { sku: 'S4001', name: 'SRV-IS-WMS-Manifold Assembly', availableQty: 10 },
            { sku: 'S4002', name: 'SRV-IS-WMS-Solenoid Valve', availableQty: 30 },
            { sku: 'S4003', name: 'SRV-IS-WMS-Pressure Regulator', availableQty: 18 }
        ];

        // Old ID-based SKU Autocomplete - kept for backwards compatibility
        // The main setupSkuAutocomplete function is defined above and uses row-based approach

        // Initialize SKU autocomplete for the first row
        const firstInventoryRow = document.querySelector('#inventoryPartsBody tr');
        if (firstInventoryRow) {
            setupSkuAutocomplete(firstInventoryRow);
        }

        // Calculate extended amount (Quantity √ó Unit Price)
        function calculateExtendedAmount(inputElement) {
            const row = inputElement.closest('tr');
            if (!row) return;
            
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');
            const extendedInput = row.querySelector('.extended-amount');
            
            if (qtyInput && priceInput && extendedInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const extended = qty * price;
                
                // Format as currency
                extendedInput.value = extended > 0 ? extended.toFixed(2) : '';
            }
        }

        // Track selected row for each table
        const selectedRows = {
            inventoryPartsBody: null,
            nonInventoryPartsBody: null,
            calibrationGasBody: null
        };

        // Row templates for each table type
        function getRowTemplate(tableType) {
            if (tableType === 'inventory') {
                return `
                    <td>
                        <div class="sku-autocomplete">
                            <input type="text" class="form-input sku-input" placeholder="<Type then tab>" autocomplete="off">
                            <div class="sku-dropdown"></div>
                        </div>
                    </td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="number" class="form-input qty-input" style="width: 60px;" oninput="calculateExtendedAmount(this)"></td>
                    <td><input type="number" class="form-input price-input" style="width: 80px;" oninput="calculateExtendedAmount(this)"></td>
                    <td><input type="text" class="form-input extended-amount" style="width: 80px;" readonly></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input" style="width: 80px;" readonly></td>
                `;
            } else if (tableType === 'nonInventory') {
                return `
                    <td>
                        <div class="autocomplete-input">
                            <input type="text" class="form-input" placeholder="<Type then tab>">
                        </div>
                    </td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="number" class="form-input qty-input" style="width: 60px;" oninput="calculateExtendedAmount(this)"></td>
                    <td><input type="number" class="form-input price-input" style="width: 80px;" oninput="calculateExtendedAmount(this)"></td>
                    <td><input type="text" class="form-input extended-amount" style="width: 80px;" readonly></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                `;
            } else if (tableType === 'calibrationGas') {
                return `
                    <td><input type="text" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="date" class="form-input"></td>
                    <td><input type="text" class="form-input"></td>
                    <td><input type="number" class="form-input"></td>
                    <td><input type="number" class="form-input"></td>
                `;
            }
        }

        // Check if row has data
        function rowHasData(row) {
            const inputs = row.querySelectorAll('input, select, textarea');
            for (const input of inputs) {
                if (input.type === 'checkbox' && input.checked) return true;
                if (input.value && input.value.trim() !== '') return true;
            }
            return false;
        }

        // Handle file selection in Reports & Files table
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const row = input.closest('tr');
                const cells = row.querySelectorAll('td');
                
                // Generate unique ID for this file
                const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Store file in the Map
                reportsFilesStore.set(fileId, file);
                
                // Update file name input
                const fileNameInput = cells[0].querySelector('.file-name-input');
                fileNameInput.value = file.name;
                fileNameInput.dataset.fileId = fileId;
                fileNameInput.dataset.fileData = JSON.stringify({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified
                });
                
                // Update other cells
                cells[1].querySelector('input').value = 'Documents'; // Default folder
                cells[2].querySelector('input').value = (file.size / 1024).toFixed(1);
                cells[3].querySelector('input').value = new Date(file.lastModified).toLocaleDateString();
                cells[4].querySelector('input').value = file.type.split('/')[1]?.toUpperCase() || file.name.split('.').pop().toUpperCase();
            }
        }

        // Add file row
        function addFileRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            const lastRow = rows[rows.length - 1];
            const fileNameInput = lastRow.querySelector('.file-name-input');

            if (!fileNameInput || !fileNameInput.value) {
                showNotification('Please select a file first', 'error');
                return;
            }

            // Mark row as saved
            lastRow.classList.remove('parts-input-row');
            lastRow.classList.add('saved-row');

            // Make the row selectable
            lastRow.onclick = function() {
                tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                this.classList.add('selected');
            };

            // Create new input row
            const newRow = document.createElement('tr');
            newRow.className = 'parts-input-row';
            newRow.innerHTML = `
                <td>
                    <div class="file-input-wrapper">
                        <input type="text" class="form-input file-name-input" placeholder="<Type then tab>" readonly onclick="this.nextElementSibling.click()">
                        <input type="file" class="hidden-file-input" style="display: none;" onchange="handleFileSelect(this)">
                        <span class="file-dropdown-icon">‚ñº</span>
                    </div>
                </td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
            `;
            tbody.appendChild(newRow);

            saveFormData();
            showNotification('File added successfully');
        }

        // Cancel file row input
        function cancelFileRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const inputRow = tbody.querySelector('.parts-input-row');
            if (inputRow) {
                const inputs = inputRow.querySelectorAll('input');
                inputs.forEach(input => {
                    if (!input.disabled) input.value = '';
                });
            }
        }

        // Insert file row before selected
        function insertFileRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const selectedRow = tbody.querySelector('.selected');
            if (!selectedRow) {
                showNotification('Please select a row first', 'error');
                return;
            }

            const newRow = document.createElement('tr');
            newRow.className = 'parts-input-row';
            newRow.innerHTML = `
                <td>
                    <div class="file-input-wrapper">
                        <input type="text" class="form-input file-name-input" placeholder="<Type then tab>" readonly onclick="this.nextElementSibling.click()">
                        <input type="file" class="hidden-file-input" style="display: none;" onchange="handleFileSelect(this)">
                        <span class="file-dropdown-icon">‚ñº</span>
                    </div>
                </td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
                <td><input type="text" class="form-input" disabled></td>
            `;
            tbody.insertBefore(newRow, selectedRow);
        }

        // Remove selected file row
        function removeFileRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const selectedRow = tbody.querySelector('.selected');
            if (selectedRow && !selectedRow.classList.contains('parts-input-row')) {
                // Remove file from store
                const fileNameInput = selectedRow.querySelector('.file-name-input');
                if (fileNameInput && fileNameInput.dataset.fileId) {
                    reportsFilesStore.delete(fileNameInput.dataset.fileId);
                }
                selectedRow.remove();
                saveFormData();
                showNotification('File removed');
            } else {
                showNotification('Please select a saved file row to remove', 'error');
            }
        }

        // Remove all files
        function removeAllFiles(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const savedRows = tbody.querySelectorAll('.saved-row');
            if (savedRows.length === 0) {
                showNotification('No files to remove', 'error');
                return;
            }

            // Remove files from store
            savedRows.forEach(row => {
                const fileNameInput = row.querySelector('.file-name-input');
                if (fileNameInput && fileNameInput.dataset.fileId) {
                    reportsFilesStore.delete(fileNameInput.dataset.fileId);
                }
                row.remove();
            });
            saveFormData();
            showNotification('All files removed');
        }

        // Add a new row to the table
        function addTableRow(tableBodyId, tableType) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            const lastRow = rows[rows.length - 1];

            // Check if last row has data
            if (lastRow && !rowHasData(lastRow)) {
                showNotification('Please fill in the current row before adding a new one', 'error');
                return;
            }

            // Convert the input row to a saved row (remove input styling, make it look saved)
            if (lastRow) {
                lastRow.classList.remove('parts-input-row');
                lastRow.classList.add('parts-saved-row');
                lastRow.onclick = function() { selectRow(tableBodyId, this); };
            }

            // Create new input row
            const newRow = document.createElement('tr');
            newRow.className = 'parts-input-row';
            newRow.innerHTML = getRowTemplate(tableType);
            tbody.appendChild(newRow);

            // Setup SKU autocomplete for inventory rows
            if (tableType === 'inventory') {
                setupSkuAutocomplete(newRow);
            }

            // Focus the first input
            const firstInput = newRow.querySelector('input');
            if (firstInput) firstInput.focus();

            showNotification('Row added successfully');
            saveFormData(); // Save to localStorage
        }

        // Cancel/clear the current input row
        function cancelTableRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const inputRow = tbody.querySelector('tr.parts-input-row');
            if (inputRow) {
                const inputs = inputRow.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                showNotification('Row cleared');
            }
        }

        // Insert a new row at selected position
        function insertTableRow(tableBodyId, tableType) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const selectedRow = selectedRows[tableBodyId];
            
            const newRow = document.createElement('tr');
            newRow.className = 'parts-saved-row';
            newRow.innerHTML = getRowTemplate(tableType);
            newRow.onclick = function() { selectRow(tableBodyId, this); };

            if (selectedRow && tbody.contains(selectedRow)) {
                tbody.insertBefore(newRow, selectedRow);
            } else {
                // Insert before the input row (last row)
                const inputRow = tbody.querySelector('tr.parts-input-row');
                if (inputRow) {
                    tbody.insertBefore(newRow, inputRow);
                } else {
                    tbody.appendChild(newRow);
                }
            }

            // Setup SKU autocomplete for inventory rows
            if (tableType === 'inventory') {
                setupSkuAutocomplete(newRow);
            }

            showNotification('Row inserted');
            saveFormData();
        }

        // Remove selected row
        function removeTableRow(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const selectedRow = selectedRows[tableBodyId];
            
            if (selectedRow && tbody.contains(selectedRow)) {
                selectedRow.remove();
                selectedRows[tableBodyId] = null;
                showNotification('Row removed');
                saveFormData();
            } else {
                // Remove last saved row if nothing selected
                const savedRows = tbody.querySelectorAll('tr.parts-saved-row');
                if (savedRows.length > 0) {
                    savedRows[savedRows.length - 1].remove();
                    showNotification('Last row removed');
                    saveFormData();
                } else {
                    showNotification('No row to remove', 'error');
                }
            }
        }

        // Move row up, down, to top, or to bottom
        function moveTableRow(tableBodyId, direction) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            const selectedRow = selectedRows[tableBodyId];
            if (!selectedRow || !tbody.contains(selectedRow)) {
                showNotification('Please select a row to move', 'error');
                return;
            }

            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const inputRow = tbody.querySelector('tr.parts-input-row');
            const savedRows = allRows.filter(r => r !== inputRow);
            const currentIndex = savedRows.indexOf(selectedRow);

            if (currentIndex === -1) return;

            switch (direction) {
                case 'up':
                    if (currentIndex > 0) {
                        tbody.insertBefore(selectedRow, savedRows[currentIndex - 1]);
                        showNotification('Row moved up');
                    }
                    break;
                case 'down':
                    if (currentIndex < savedRows.length - 1) {
                        const nextRow = savedRows[currentIndex + 1];
                        if (nextRow.nextSibling) {
                            tbody.insertBefore(selectedRow, nextRow.nextSibling);
                        } else {
                            tbody.insertBefore(selectedRow, inputRow);
                        }
                        showNotification('Row moved down');
                    }
                    break;
                case 'top':
                    if (currentIndex > 0) {
                        tbody.insertBefore(selectedRow, savedRows[0]);
                        showNotification('Row moved to top');
                    }
                    break;
                case 'bottom':
                    if (currentIndex < savedRows.length - 1) {
                        tbody.insertBefore(selectedRow, inputRow);
                        showNotification('Row moved to bottom');
                    }
                    break;
            }
            saveFormData();
        }

        // Select a row
        function selectRow(tableBodyId, row) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;

            // Deselect previous
            tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
            
            // Select new
            row.classList.add('selected-row');
            selectedRows[tableBodyId] = row;
        }

        // Setup SKU autocomplete for a row
        function setupSkuAutocomplete(row) {
            const skuInput = row.querySelector('.sku-input');
            const skuDropdown = row.querySelector('.sku-dropdown');
            const descInput = row.querySelectorAll('input')[1]; // Description is second input

            if (!skuInput || !skuDropdown) return;

            skuInput.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 1) {
                    skuDropdown.style.display = 'none';
                    return;
                }

                const matches = skuData.filter(item => 
                    item.sku.toLowerCase().includes(value) || 
                    item.name.toLowerCase().includes(value)
                );

                if (matches.length > 0) {
                    skuDropdown.innerHTML = matches.map(item => 
                        `<div class="sku-item" data-sku="${item.sku}" data-name="${item.name}" data-qty="${item.availableQty}">
                            <strong>${item.sku}</strong> - ${item.name}
                        </div>`
                    ).join('');
                    skuDropdown.style.display = 'block';

                    skuDropdown.querySelectorAll('.sku-item').forEach(item => {
                        item.addEventListener('click', function() {
                            skuInput.value = this.dataset.sku;
                            if (descInput) descInput.value = this.dataset.name;
                            const availQtyInput = row.querySelector('input[readonly]:last-of-type');
                            if (availQtyInput) availQtyInput.value = this.dataset.qty;
                            skuDropdown.style.display = 'none';
                        });
                    });
                } else {
                    skuDropdown.style.display = 'none';
                }
            });

            skuInput.addEventListener('blur', function() {
                setTimeout(() => { skuDropdown.style.display = 'none'; }, 200);
            });

            skuInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' || e.key === 'Enter') {
                    const value = this.value.toLowerCase();
                    const exactMatch = skuData.find(item => item.sku.toLowerCase() === value);
                    if (exactMatch) {
                        this.value = exactMatch.sku;
                        if (descInput) descInput.value = exactMatch.name;
                        const availQtyInput = row.querySelector('input[readonly]:last-of-type');
                        if (availQtyInput) availQtyInput.value = exactMatch.availableQty;
                    }
                    skuDropdown.style.display = 'none';
                }
            });
        }

        // Switch tabs
        function switchTab(tab, tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Address data for Ship To Select
        const addressData = {
            '1204-lenco': {
                company: 'Midwest Sterilization Corporation',
                street: '1204 Lenco Avenue',
                city: 'Jackson',
                state: 'MO',
                zip: '63755',
                country: 'United States',
                phone: '(573) 243-8456'
            },
            'custom': null
        };

        // Update Ship To address display
        function updateShipToAddress() {
            const select = document.getElementById('shipToSelect');
            const addressDisplay = document.getElementById('shipToAddress');
            const selectedValue = select.value;

            if (selectedValue && addressData[selectedValue]) {
                const addr = addressData[selectedValue];
                addressDisplay.innerHTML = `
                    <div>${addr.company}</div>
                    <div>${addr.street}</div>
                    <div>${addr.city} ${addr.state} ${addr.zip}</div>
                    <div>${addr.country}</div>
                    <div>${addr.phone}</div>
                `;
            } else if (selectedValue === 'custom') {
                addressDisplay.innerHTML = `
                    <div><input type="text" class="form-input" placeholder="Company Name" style="width: 100%; margin-bottom: 5px;"></div>
                    <div><input type="text" class="form-input" placeholder="Street Address" style="width: 100%; margin-bottom: 5px;"></div>
                    <div><input type="text" class="form-input" placeholder="City, State ZIP" style="width: 100%; margin-bottom: 5px;"></div>
                    <div><input type="text" class="form-input" placeholder="Country" style="width: 100%; margin-bottom: 5px;"></div>
                    <div><input type="text" class="form-input" placeholder="Phone" style="width: 100%;"></div>
                `;
            } else {
                addressDisplay.innerHTML = '<div style="color: #999; font-style: italic;">Select an address above</div>';
            }
            saveFormData();
        }

        // Open map for address
        function openMap() {
            const addr = addressData['1204-lenco'];
            if (addr) {
                const query = encodeURIComponent(`${addr.street}, ${addr.city}, ${addr.state} ${addr.zip}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#4caf50' : '#f44336';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Save form
        function saveForm() {
            // Validate required fields
            const subject = document.getElementById('subject').value;
            const company = document.getElementById('company').value;
            const profile = document.getElementById('profile').value;
            const status = document.getElementById('status').value;
            const serviceStartDate = document.getElementById('serviceStartDate').value;
            const typeOfService = document.getElementById('typeOfService')?.value || '';
            if (!subject) {
                showNotification('Subject is required', 'error');
                document.getElementById('subject').focus();
                return;
            }

            // Generate case number
            const caseNumber = 'CASE' + Date.now().toString().slice(-8);
            document.getElementById('caseNumber').value = caseNumber;

            showNotification('Case saved successfully! Case #: ' + caseNumber);
        }

        // Cancel form
        function cancelForm() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                location.reload();
            }
        }

        // Toggle save menu
        function toggleSaveMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('saveDropdown');
            const rect = event.target.getBoundingClientRect();
            
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.left = (rect.left - 100) + 'px';
            dropdown.classList.toggle('show');
        }

        // Save and new
        function saveAndNew() {
            saveForm();
            setTimeout(() => {
                if (confirm('Create a new case?')) {
                    location.reload();
                }
            }, 1000);
        }

        // Save and email
        function saveAndEmail() {
            saveForm();
            showNotification('Email dialog would open here');
        }

        // Save and print
        function saveAndPrint() {
            saveForm();
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            document.getElementById('saveDropdown').classList.remove('show');
        });

        // File drop area functionality
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');

        fileDropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.style.background = '#e8f5e9';
            fileDropArea.style.borderColor = '#2e7d32';
        });

        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.style.background = '#f9f9f9';
            fileDropArea.style.borderColor = '';
        });

        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.style.background = '#f9f9f9';
            fileDropArea.style.borderColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                showNotification(`${files.length} file(s) attached`);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                showNotification(`${fileInput.files.length} file(s) selected`);
            }
        });

        // Auto-populate contact from company; email/phone when company changes
        function updateContactFromCompany() {
            const companySelect = document.getElementById('company');
            const contactSelect = document.getElementById('contact');
            if (!companySelect || !contactSelect) return;
            contactSelect.value = companySelect.value || '';
        }

        document.getElementById('company').addEventListener('change', function() {
            updateContactFromCompany();
            if (this.value === 'cu20602') {
                document.getElementById('email').value = 'JoyW@midweststerilization.com';
                document.getElementById('phone').value = '(573) 243-8456';
            } else if (this.value === 'cu23744') {
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
            } else {
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
            }
        });

        // Set contact from company on load (e.g. after loading saved data)
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateContactFromCompany, 100);
        });


        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveForm();
            }
            // Escape to cancel
            if (e.key === 'Escape') {
                cancelForm();
            }
        });

        // Date initialization moved to setDefaultValues() function above

        // Case Issue Secondary options based on Case Issue selection
        const caseIssueSecondaryOptions = {
            'cems-ancillary': [
                { value: 'sample-probe', text: 'Sample Probe' },
                { value: 'flow-probe', text: 'Flow Probe' },
                { value: 'sample-line', text: 'Sample Line' }
            ],
            'cems-mechanical': [
                { value: 'sample-pump', text: 'Sample Pump' },
                { value: 'priming-pump', text: 'Priming Pump' },
                { value: 'mfc', text: 'MFC' },
                { value: 'calibration-solenoids', text: 'Calibration Solenoids' },
                { value: 'sampling-solenoids', text: 'Sampling Solenoids' },
                { value: 'picarro-vacuum-pump', text: 'Picarro Vacuum Pump' },
                { value: 'other', text: 'Other' }
            ],
            'cems-software': [
                { value: 'reporting-module', text: 'Reporting Module' },
                { value: 'database', text: 'Database' },
                { value: 'sqlite', text: 'SQLite' },
                { value: 'other', text: 'Other' }
            ]
        };

        // Update Case Issue Secondary when Case Issue changes
        document.getElementById('caseIssue').addEventListener('change', function() {
            const secondarySelect = document.getElementById('caseIssueSecondary');
            const selectedIssue = this.value;
            
            // Clear existing options
            secondarySelect.innerHTML = '';
            
            if (caseIssueSecondaryOptions[selectedIssue]) {
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select --';
                secondarySelect.appendChild(defaultOption);
                
                // Add specific options for selected case issue
                caseIssueSecondaryOptions[selectedIssue].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    secondarySelect.appendChild(option);
                });
            } else {
                // No secondary options for this selection
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- N/A for this Case Issue --';
                secondarySelect.appendChild(defaultOption);
            }
        });
    </script>
</body>
</html>